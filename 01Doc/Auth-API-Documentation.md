# üîê **Auth Service API Documentation - Asistente Voz Realtime v1.0**

## üì° **Informaci√≥n General**

### **üåê Base URL**
```
http://192.168.3.3:8001
```

### **üîß Configuraci√≥n**
- **Puerto**: `8001`
- **Base de datos**: `MongoDB - auth_db`
- **Token**: JWT con expiraci√≥n de 7 d√≠as
- **Email**: Simulado en desarrollo (logs)

### **üéØ Funcionalidades**
- ‚úÖ Registro de usuarios con validaci√≥n de email
- ‚úÖ Login con JWT tokens
- ‚úÖ Verificaci√≥n de email con c√≥digos de 6 d√≠gitos
- ‚úÖ Recuperaci√≥n de contrase√±a
- ‚úÖ Perfil de usuario protegido
- ‚úÖ Estad√≠sticas del servicio

---

## üìñ **Endpoints**

### **üè† 1. Health Check**
**GET** `/`

**Descripci√≥n**: Verificar estado del servicio

**Response**:
```json
{
  "service": "üîê Auth Service",
  "status": "healthy", 
  "version": "1.0.0",
  "timestamp": "2024-01-26T14:30:52.123456"
}
```

**Ejemplo**:
```bash
curl -X GET http://192.168.3.3:8001/
```

---

### **üë§ 2. Registro de Usuario**
**POST** `/register`

**Descripci√≥n**: Registrar un nuevo usuario y enviar c√≥digo de verificaci√≥n

**Body (JSON)**:
```json
{
  "email": "usuario@example.com",
  "password": "miPassword123",
  "full_name": "Juan P√©rez"
}
```

**Validaciones**:
- Email v√°lido y √∫nico
- Contrase√±a: m√≠nimo 8 caracteres, letras y n√∫meros
- Nombre completo requerido

**Response Success (201)**:
```json
{
  "success": true,
  "message": "Usuario registrado exitosamente. Revisa tu email para el c√≥digo de verificaci√≥n.",
  "user_id": "user_abc12345",
  "verification_required": true
}
```

**Response Error (400)**:
```json
{
  "detail": "El email ya est√° registrado"
}
```

**Ejemplo**:
```bash
curl -X POST http://192.168.3.3:8001/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testPass123",
    "full_name": "Usuario Test"
  }'
```

---

### **‚úÖ 3. Verificaci√≥n de Email**
**POST** `/verify-email`

**Descripci√≥n**: Verificar email con c√≥digo de 6 d√≠gitos

**Body (JSON)**:
```json
{
  "email": "usuario@example.com",
  "code": "123456"
}
```

**Response Success (200)**:
```json
{
  "success": true,
  "message": "Email verificado exitosamente. Ya puedes iniciar sesi√≥n."
}
```

**Response Error (400)**:
```json
{
  "detail": "C√≥digo inv√°lido o expirado"
}
```

**Ejemplo**:
```bash
curl -X POST http://192.168.3.3:8001/verify-email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "code": "123456"
  }'
```

---

### **üîë 4. Login**
**POST** `/login`

**Descripci√≥n**: Iniciar sesi√≥n y obtener JWT token

**Body (JSON)**:
```json
{
  "email": "usuario@example.com",
  "password": "miPassword123"
}
```

**Response Success (200)**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "user_id": "user_abc12345",
    "email": "usuario@example.com",
    "full_name": "Juan P√©rez",
    "is_verified": true,
    "created_at": "2024-01-26T14:30:52.123456",
    "last_login": "2024-01-26T15:45:30.789012"
  }
}
```

**Response Error (401)**:
```json
{
  "detail": "Credenciales inv√°lidas"
}
```

**Response Error (401) - Email no verificado**:
```json
{
  "detail": "Debes verificar tu email antes de iniciar sesi√≥n"
}
```

**Ejemplo**:
```bash
curl -X POST http://192.168.3.3:8001/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testPass123"
  }'
```

---

### **üîí 5. Solicitar Recuperaci√≥n de Contrase√±a**
**POST** `/forgot-password`

**Descripci√≥n**: Enviar c√≥digo de recuperaci√≥n por email

**Body (JSON)**:
```json
{
  "email": "usuario@example.com"
}
```

**Response Success (200)**:
```json
{
  "success": true,
  "message": "Si el email existe, recibir√°s un c√≥digo de recuperaci√≥n."
}
```

**Ejemplo**:
```bash
curl -X POST http://192.168.3.3:8001/forgot-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com"
  }'
```

---

### **üîÑ 6. Resetear Contrase√±a**
**POST** `/reset-password`

**Descripci√≥n**: Cambiar contrase√±a con c√≥digo de recuperaci√≥n

**Body (JSON)**:
```json
{
  "email": "usuario@example.com",
  "code": "654321",
  "new_password": "nuevaPassword456"
}
```

**Response Success (200)**:
```json
{
  "success": true,
  "message": "Contrase√±a actualizada exitosamente."
}
```

**Response Error (400)**:
```json
{
  "detail": "C√≥digo inv√°lido o expirado"
}
```

**Ejemplo**:
```bash
curl -X POST http://192.168.3.3:8001/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "code": "654321",
    "new_password": "newTestPass123"
  }'
```

---

### **üë§ 7. Perfil de Usuario (Protegido)**
**GET** `/profile`

**Descripci√≥n**: Obtener informaci√≥n del usuario autenticado

**Headers**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response Success (200)**:
```json
{
  "user_id": "user_abc12345",
  "email": "usuario@example.com", 
  "full_name": "Juan P√©rez",
  "is_verified": true,
  "created_at": "2024-01-26T14:30:52.123456",
  "last_login": "2024-01-26T15:45:30.789012"
}
```

**Response Error (401)**:
```json
{
  "detail": "Token requerido"
}
```

**Ejemplo**:
```bash
curl -X GET http://192.168.3.3:8001/profile \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

### **üìä 8. Estad√≠sticas del Servicio**
**GET** `/stats`

**Descripci√≥n**: Obtener estad√≠sticas generales del servicio

**Response Success (200)**:
```json
{
  "total_users": 25,
  "verified_users": 20,
  "pending_verification": 5,
  "recent_registrations_7days": 8,
  "verification_rate": 80.0
}
```

**Ejemplo**:
```bash
curl -X GET http://192.168.3.3:8001/stats
```

---

## üîÑ **Flujo de Uso Completo**

### **üìù 1. Registro + Verificaci√≥n**
```bash
# 1. Registrar usuario
curl -X POST http://192.168.3.3:8001/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testPass123","full_name":"Test User"}'

# 2. Verificar email (revisar logs para obtener c√≥digo)
curl -X POST http://192.168.3.3:8001/verify-email \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","code":"123456"}'
```

### **üîë 2. Login + Uso del Token**
```bash
# 1. Login
RESPONSE=$(curl -X POST http://192.168.3.3:8001/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testPass123"}')

# 2. Extraer token (ejemplo con jq)
TOKEN=$(echo $RESPONSE | jq -r '.access_token')

# 3. Usar token para acceder al perfil
curl -X GET http://192.168.3.3:8001/profile \
  -H "Authorization: Bearer $TOKEN"
```

### **üîí 3. Recuperaci√≥n de Contrase√±a**
```bash
# 1. Solicitar reset
curl -X POST http://192.168.3.3:8001/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com"}'

# 2. Reset con c√≥digo (revisar logs para c√≥digo)
curl -X POST http://192.168.3.3:8001/reset-password \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","code":"654321","new_password":"newPassword123"}'
```

---

## üì± **Integraci√≥n con Flutter**

### **üîß Configuraci√≥n en Flutter**
```dart
// En config.json
{
  "auth_base_url": "http://192.168.3.3:8001",
  "endpoints": {
    "register": "/register",
    "verify_email": "/verify-email", 
    "login": "/login",
    "forgot_password": "/forgot-password",
    "reset_password": "/reset-password",
    "profile": "/profile"
  }
}
```

### **üìä Ejemplo de Uso en Dart**
```dart
// Registro
final response = await http.post(
  Uri.parse('${config.authBaseUrl}/register'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({
    'email': email,
    'password': password,
    'full_name': fullName,
  }),
);

// Login
final loginResponse = await http.post(
  Uri.parse('${config.authBaseUrl}/login'),
  headers: {'Content-Type': 'application/json'},
  body: jsonEncode({
    'email': email,
    'password': password,
  }),
);

// Usar token en requests
final headers = {
  'Content-Type': 'application/json',
  'Authorization': 'Bearer $token',
};
```

---

## üåê **Topics MQTT por Usuario**

Una vez autenticado, el `user_id` se usa para los topics MQTT:

### **üì° Estructura de Topics**
```
audio/transcription/{user_id}  # Ej: audio/transcription/user_abc12345
audio/status/{user_id}         # Ej: audio/status/user_abc12345  
audio/notification/{user_id}   # Ej: audio/notification/user_abc12345
audio/task/{user_id}           # Ej: audio/task/user_abc12345
audio/emotion/{user_id}        # Ej: audio/emotion/user_abc12345
audio/flutter/{user_id}        # Ej: audio/flutter/user_abc12345
```

### **üîó Conexi√≥n del Flujo**
1. **Usuario se registra y verifica** ‚Üí Obtiene `user_id`
2. **App Flutter usa user_id** ‚Üí Para suscribirse a topics espec√≠ficos
3. **Backend usa user_id** ‚Üí Para enviar mensajes al usuario correcto
4. **Monitor universal** ‚Üí Sigue capturando con wildcard `audio/*`

---

## üõ†Ô∏è **Base de Datos**

### **üë• Colecci√≥n `users`**
```json
{
  "_id": ObjectId("..."),
  "user_id": "user_abc12345",
  "email": "usuario@example.com",
  "password": "salt:hashedpassword",
  "full_name": "Juan P√©rez",
  "is_verified": true,
  "created_at": ISODate("2024-01-26T14:30:52.123Z"),
  "last_login": ISODate("2024-01-26T15:45:30.789Z")
}
```

### **üìß Colecci√≥n `verification_codes`**
```json
{
  "_id": ObjectId("..."),
  "email": "usuario@example.com",
  "code": "123456",
  "expires_at": ISODate("2024-01-26T14:45:52.123Z")
}
```

### **üîë Colecci√≥n `password_resets`**
```json
{
  "_id": ObjectId("..."),
  "email": "usuario@example.com",
  "code": "654321",
  "expires_at": ISODate("2024-01-26T15:00:52.123Z")
}
```

---

## üö® **C√≥digos de Error**

| C√≥digo | Descripci√≥n | Ejemplo |
|--------|-------------|---------|
| 200 | √âxito | Login exitoso |
| 201 | Creado | Usuario registrado |
| 400 | Bad Request | Email ya existe, contrase√±a d√©bil |
| 401 | No autorizado | Credenciales inv√°lidas, token expirado |
| 404 | No encontrado | Usuario no existe |
| 500 | Error interno | Error de base de datos |

---

## üß™ **Testing**

### **üîß Herramientas en `/agent`**
- `auth-tester.py` - Probador interactivo de todos los endpoints
- `user-creator.py` - Creador autom√°tico de usuarios de prueba
- `mqtt-user-monitor.py` - Monitor espec√≠fico por usuario

### **üìã Casos de Prueba**
1. ‚úÖ Registro con email v√°lido
2. ‚úÖ Registro con email duplicado (error)
3. ‚úÖ Verificaci√≥n con c√≥digo correcto
4. ‚úÖ Verificaci√≥n con c√≥digo expirado (error)
5. ‚úÖ Login con credenciales correctas
6. ‚úÖ Login sin verificar email (error)
7. ‚úÖ Recuperaci√≥n de contrase√±a
8. ‚úÖ Reset con c√≥digo v√°lido
9. ‚úÖ Acceso a perfil con token v√°lido
10. ‚úÖ Acceso a perfil con token expirado (error)

---

*üìÖ √öltima actualizaci√≥n: 2024-01-26*  
*üîÑ Este documento se mantiene sincronizado con el c√≥digo del servicio* 